<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restaurante Escolar IE Baldomero Sanín Cano</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { padding: 1rem; background:#f4f6f9; }
    header { display:flex; align-items:center; justify-content:center; background:linear-gradient(90deg,#d32f2f,#1976d2,#388e3c); padding:12px 20px; border-radius:10px; margin-bottom:1rem; color:white; box-shadow:0 3px 6px rgba(0,0,0,0.2);}
    header img { height:65px; margin-right:15px; }
    header h2{ margin:0; font-size:1.4rem; } header h3{ margin:0; font-size:1rem; font-weight:normal; opacity:0.9; }

    #video { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; }
    .flash { animation: flashAnim 0.4s; }
    @keyframes flashAnim { 0%{background-color:#ffff99;}50%{background-color:#f4f6f9;}100%{background-color:#f4f6f9;} }
    @media print{ body *{visibility:hidden;} #print-area,#print-area *{visibility:visible;} #print-area{position:absolute;left:0;top:0;width:100%; display:flex; flex-wrap:wrap; padding:10px; box-sizing:border-box;} .label{width:32%; margin:1%; text-align:center; page-break-inside:avoid; display:flex; flex-direction:column; align-items:center;} .label-name{margin-top:5px;font-size:12px;text-align:center;} }
    .label { border:2px dashed #1976d2; padding:6px; margin:6px; display:inline-flex; flex-direction:column; align-items:center; width:30%; border-radius:8px; background:white; }
    .label .label-name { margin-top:6px; font-size:13px; text-align:center; color:#d32f2f; font-weight:bold; }

    #importBtn { background-color:#388e3c; color:white; font-weight:bold; }
    #printAll { background-color:#1976d2; color:white; }
    #exportPDF { background-color:black; color:white; font-weight:bold; }
    #clearData { background-color:#d32f2f; color:white; }
    #startScanner { border-color:#1976d2; color:#1976d2; }
    #stopScanner { border-color:#d32f2f; color:#d32f2f; }
  </style>
</head>
<body>
  <header>
    <img src="logo_colegio.png" alt="Logo Colegio">
    <div>
      <h2>IE Baldomero Sanín Cano</h2>
      <h2>Restaurante Escolar</h2>
      <h3>Diseño: Uv@profe</h3>
    </div>
  </header>

  <div class="container">
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card mb-3">
          <div class="card-body">
            <h5>Importar estudiantes (CSV)</h5>
            <input id="csvFile" type="file" accept=".csv,text/csv" class="form-control mb-2" />
            <button id="importBtn" class="btn w-100 mt-2">Cargar CSV</button>
            <hr/>

            <h5>Escáner QR</h5>
            <div id="scanner-controls" class="mb-2">
              <button id="startScanner" class="btn w-100 mb-1">Iniciar escáner</button>
              <button id="stopScanner" class="btn w-100 mb-1">Detener escáner</button>
            </div>

            <div id="scanner-area" style="display:none;">
              <video id="video" autoplay playsinline></video>
              <canvas id="canvas" style="display:none;"></canvas>
              <small id="scanStatus" class="text-success"></small>

              <div class="mt-2">
                <label for="gradeFilter" class="form-label">Filtrar por grado:</label>
                <select id="gradeFilter" class="form-select">
                  <option value="all">Todos los grados</option>
                </select>
              </div>

              <ul id="todayStudents" class="list-group list-group-flush mt-2"></ul>

              <button id="exportPDF" class="btn w-100 mt-2">Exportar PDF</button>
            </div>
            <hr/>
            <button id="printAll" class="btn w-100">Imprimir todos los QRs</button>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5>Dashboard (tiempo real)</h5>
            <p>Total estudiantes: <strong id="totalStudents">0</strong></p>
            <p>Asistencias hoy (<span id="todayDate"></span>): <strong id="attToday">0</strong></p>
            <p>Asistencias totales: <strong id="attTotal">0</strong></p>
            <button id="clearData" class="btn btn-sm">Borrar toda la base (local)</button>
          </div>
        </div>

        <!-- Nueva sección de Estadística últimos 5 días hábiles -->
        <div class="card mt-3">
          <div class="card-body">
            <h5>Estadística últimos 5 días hábiles</h5>
            <canvas id="attendanceChart" height="100"></canvas>
            <p>Total asistencias últimos 5 días: <span id="totalLast5Days">0</span></p>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div id="print-area" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Sistema existente ---
    const STORAGE_STUDENTS='rs_students_v1';
    const STORAGE_ATT='rs_attendance_v1';
    function readStudents(){ return JSON.parse(localStorage.getItem(STORAGE_STUDENTS)||'[]'); }
    function writeStudents(a){ localStorage.setItem(STORAGE_STUDENTS,JSON.stringify(a)); }
    function readAttendance(){ return JSON.parse(localStorage.getItem(STORAGE_ATT)||'{}'); }
    function writeAttendance(o){ localStorage.setItem(STORAGE_ATT,JSON.stringify(o)); }
    function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    function todayKey(){ return new Date().toISOString().slice(0,10); }

    const totalStudentsEl=document.getElementById('totalStudents');
    const attTodayEl=document.getElementById('attToday');
    const attTotalEl=document.getElementById('attTotal');
    document.getElementById('todayDate').textContent=todayKey();
    const gradeFilter=document.getElementById('gradeFilter');

    // --- CSV import ---
    document.getElementById('importBtn').addEventListener('click',()=>{
      const f=document.getElementById('csvFile').files[0];
      if(!f){ alert('Seleccione CSV'); return; }
      Papa.parse(f,{
        header:true, skipEmptyLines:true,
        complete(results){
          const arr=readStudents(); let added=0;
          for(const r of results.data){
            const name=(r.name||'').trim();
            const grade=(r.grade||'').trim();
            if(!name) continue;
            arr.push({id:uid(), name, grade, createdAt:new Date().toISOString()});
            added++;
          }
          writeStudents(arr);
          alert(`Importación finalizada: ${added} estudiantes añadidos.`);
          renderDashboard(); updateGradeFilter(); renderAttendanceChart(); renderTodayList();
        }
      });
    });

    // --- Attendance ---
    function registerAttendanceQR(name, grade){
      const students=readStudents();
      const student=students.find(s=>s.name===name&&s.grade===grade);
      if(!student) return 'notfound';
      const att=readAttendance(); const key=todayKey();
      if(!att[key]) att[key]={};
      if(att[key][student.id]) return 'already';
      att[key][student.id]=new Date().toISOString();
      writeAttendance(att);
      renderDashboard(); renderTodayList(); renderAttendanceChart();
      return student.name;
    }

    function renderDashboard(){
      const students=readStudents();
      const att=readAttendance(); const today=todayKey();
      totalStudentsEl.textContent=students.length;
      attTodayEl.textContent=att[today]?Object.keys(att[today]).length:0;
      attTotalEl.textContent=Object.values(att).reduce((s,o)=>s+Object.keys(o).length,0);
    }
    renderDashboard();

    function updateGradeFilter(){
      const students=readStudents();
      const unique=[...new Set(students.map(s=>s.grade))].sort();
      gradeFilter.innerHTML='<option value="all">Todos los grados</option>';
      unique.forEach(g=>{
        const opt=document.createElement('option');
        opt.value=g; opt.textContent=g;
        gradeFilter.appendChild(opt);
      });
    }
    updateGradeFilter();

    function renderTodayList(){
      const att=readAttendance();
      const today=todayKey();
      const ul=document.getElementById('todayStudents');
      ul.innerHTML='';
      if(att[today]){
        const students=readStudents();
        let index=1;
        Object.keys(att[today]).forEach(id=>{
          const s=students.find(st=>st.id===id);
          if(s){
            if(gradeFilter.value==="all" || gradeFilter.value===s.grade){
              const li=document.createElement('li');
              li.className='list-group-item flash';
              li.textContent=`${index}. ${s.name} - ${s.grade}`;
              ul.appendChild(li);
              index++;
              setTimeout(()=>li.classList.remove('flash'),400);
            }
          }
        });
      }
    }
    renderTodayList();
    gradeFilter.addEventListener('change',renderTodayList);

    // --- Attendance últimos 5 días ---
    function getLast5Weekdays(){
      const days=[];
      let date=new Date();
      while(days.length<5){
        date.setDate(date.getDate()-1);
        const day=date.getDay();
        if(day>=1 && day<=5) days.unshift(new Date(date));
      }
      return days;
    }

    function renderAttendanceChart(){
      const students=readStudents();
      const att=readAttendance();
      const last5=getLast5Weekdays();
      const labels=last5.map(d=>d.toLocaleDateString('es-CO',{weekday:'long',day:'2-digit',month:'short'}));
      const data=last5.map(d=>{
        const key=d.toISOString().slice(0,10);
        return att[key]?Object.keys(att[key]).length:0;
      });
      document.getElementById('totalLast5Days').textContent=data.reduce((a,b)=>a+b,0);
      const ctx=document.getElementById('attendanceChart').getContext('2d');
      if(window.last5Chart) window.last5Chart.destroy();
      window.last5Chart=new Chart(ctx,{
        type:'bar',
        data:{
          labels:labels,
          datasets:[{
            label:'Asistencias',
            data:data,
            backgroundColor:'rgba(54,162,235,0.6)',
            borderColor:'rgba(54,162,235,1)',
            borderWidth:1
          }]
        },
        options:{scales:{y:{beginAtZero:true}}}
      });
    }
    renderAttendanceChart();

    // --- PDF export actualizado ---
    document.getElementById('exportPDF').addEventListener('click',()=>{
      const att=readAttendance(); const today=todayKey();
      if(!att[today]){ alert('No hay registros hoy'); return; }
      const students=readStudents(); const { jsPDF }=window.jspdf; const doc=new jsPDF();
      const last5Total=document.getElementById('totalLast5Days').textContent;
      doc.setFontSize(14); doc.text(`Estudiantes registrados - ${today}`,14,20);
      doc.setFontSize(12); doc.text(`Total asistencias últimos 5 días: ${last5Total}`,14,28);
      const tableCol=["N°","Nombre","Grado","Fecha"];
      const tableRows=[]; let index=1;
      Object.keys(att[today]).forEach(id=>{
        const s=students.find(st=>st.id===id);
        if(s){
          if(gradeFilter.value==="all" || gradeFilter.value===s.grade){
            const dateReg=new Date(att[today][id]).toLocaleDateString('es-ES',{day:'2-digit',month:'long',year:'numeric'});
            tableRows.push([index++,s.name,s.grade,dateReg]);
          }
        }
      });
      doc.autoTable({ head:[tableCol], body:tableRows, startY:35, theme:'grid' });
      doc.save(`Estudiantes_${today}.pdf`);
    });

    // --- Scanner y Print QRs se mantiene igual ---
    let videoStream=null, scanning=false;
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const scanStatus=document.getElementById('scanStatus');
    document.getElementById('startScanner').addEventListener('click',startScanner);
    document.getElementById('stopScanner').addEventListener('click',stopScanner);
    async function startScanner(){
      if(scanning) return;
      try{
        let stream=null;
        try{ stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"environment"}}}); }
        catch(e){ stream=await navigator.mediaDevices.getUserMedia({video:true}); }
        video.srcObject=stream; videoStream=stream; scanning=true;
        document.getElementById('scanner-area').style.display='block';
        scanLoop();
      }catch(err){ alert('No se pudo acceder a la cámara: '+err.message); }
    }
    function stopScanner(){ scanning=false; if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; } document.getElementById('scanner-area').style.display='none'; scanStatus.textContent=''; }
    video.addEventListener('loadedmetadata',()=>{ video.style.height=video.offsetWidth+'px'; });

    let lastScan=0;
    function scanLoop(){
      if(!scanning) return;
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(imgData.data,imgData.width,imgData.height,{inversionAttempts:"attemptBoth"});
        if(code){
          const now=Date.now();
          if(now-lastScan>1500){
            lastScan=now; let parsed=null;
            try{ parsed=JSON.parse(code.data); }catch(e){ parsed=null; }
            if(parsed&&parsed.name&&parsed.grade){
              const res=registerAttendanceQR(parsed.name,parsed.grade);
              if(res==='notfound'){ scanStatus.textContent='Estudiante no encontrado'; speak('Estudiante no encontrado'); }
              else if(res==='already'){ scanStatus.textContent='Ya registrado'; speak('Estudiante ya registrado'); }
              else{ scanStatus.textContent=`Registrado: ${res}`; speak(`Estudiante registrado: ${res}`); }
            } else { scanStatus.textContent='QR inválido'; speak('QR inválido'); }
          }
        } else { scanStatus.textContent='Buscando QR...'; }
      }
      requestAnimationFrame(scanLoop);
    }
    function speak(t){ const u=new SpeechSynthesisUtterance(t); window.speechSynthesis.speak(u); }

    function buildPrintLabels(){
      const container=document.getElementById('print-area');
      container.innerHTML=''; container.style.display='block';
      const students=readStudents();
      for(const s of students){
        const label=document.createElement('div'); label.className='label';
        const holder=document.createElement('div'); label.appendChild(holder);
        const nameEl=document.createElement('div'); nameEl.className='label-name'; nameEl.textContent=`${s.name} - ${s.grade}`;
        label.appendChild(nameEl); container.appendChild(label);
        const payload=JSON.stringify({name:s.name,grade:s.grade});
        new QRCode(holder,{text:payload,width:140,height:140});
      }
    }
    document.getElementById('printAll').addEventListener('click',()=>{
      buildPrintLabels();
      setTimeout(()=>{ window.print(); container.style.display='none'; },500);
    });

    document.getElementById('clearData').addEventListener('click',()=>{
      if(confirm('Borrar estudiantes y asistencias?')){
        localStorage.removeItem(STORAGE_STUDENTS);
        localStorage.removeItem(STORAGE_ATT);
        renderDashboard(); renderTodayList(); updateGradeFilter(); renderAttendanceChart();
      }
    });

    // --- Demo inicial ---
    if(readStudents().length===0){
      const sample=[
        {id:uid(),name:'Carlos Pérez',grade:'10-1',createdAt:new Date().toISOString()},
        {id:uid(),name:'María Gómez',grade:'9-2',createdAt:new Date().toISOString()},
        {id:uid(),name:'Juan Rodríguez',grade:'11-3',createdAt:new Date().toISOString()},
        {id:uid(),name:'Ana Morales',grade:'10-2',createdAt:new Date().toISOString()}
      ];
      writeStudents(sample); updateGradeFilter();
    }
  </script>
</body>
</html>
