<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Restaurante Escolar IE Baldomero Sanín Cano</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body { padding: 1rem; background:#f4f6f9; }

/* Encabezado */
header {
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(90deg, #d32f2f, #1976d2, #388e3c);
  padding: 12px 20px;
  border-radius: 10px;
  margin-bottom: 1rem;
  color: white;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}
header img { height: 65px; margin-right: 15px; }
header h2 { margin: 0; font-size: 1.4rem; }
header h3 { margin: 0; font-size: 1rem; font-weight: normal; opacity: 0.9; }

/* Video escáner */
#video { width: 100%; aspect-ratio:1/1; object-fit: cover; border-radius:8px; }
.flash { animation: flashAnim 0.4s; }
@keyframes flashAnim {0% {background-color:#ffff99;}50% {background-color:#f4f6f9;}100% {background-color:#f4f6f9;}}

/* Impresión QR */
@media print {
  body * { visibility: hidden; }
  #print-area, #print-area * { visibility: visible; }
  #print-area { position: absolute; left: 0; top: 0; width: 100%; display:flex; flex-wrap:wrap; padding:10px; box-sizing:border-box; }
  .label { width:32%; margin:1%; text-align:center; page-break-inside: avoid; display:flex; flex-direction:column; align-items:center; }
  .label-name { margin-top:5px; font-size:12px; text-align:center; }
}

.label { border:2px dashed #d32f2f; padding:6px; margin:6px; display:inline-flex; flex-direction:column; align-items:center; width:30%; border-radius:8px; background:white; }
.label .label-name { margin-top:6px; font-size:13px; text-align:center; color:#d32f2f; font-weight:bold; }

/* Botones */
#importBtn { background-color:#388e3c; color:white; font-weight:bold; }
#printAll { background-color:#1976d2; color:white; }
#exportPDF { background-color:black; color:white; font-weight:bold; }
#clearData { background-color:#d32f2f; color:white; }
#startScanner { border-color:#1976d2; color:#1976d2; }
#stopScanner { border-color:#d32f2f; color:#d32f2f; }

/* Tarjeta agregar estudiante manual */
#manualStudentForm { border:2px solid #388e3c; padding:10px; border-radius:8px; background:#fff; display:none; margin-bottom:1rem; }

/* Panel principal con borde grueso verde */
.container {
  border: 4px solid #388e3c; 
  border-radius: 12px;
  padding: 1rem;
  background: #f4f6f9;
}

/* Acordeón para bloques */
.card .card-header {
  cursor: pointer;
  background-color: #d32f2f; 
  color: white;
  font-weight: bold;
  padding: 0.5rem 1rem;
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
}
.card .card-body.collapsed { display: none; }
</style>
</head>
<body>
<header>
  <img src="logo_colegio.png" alt="Logo Colegio">
  <div>
    <h2>IE Baldomero Sanín Cano</h2>
    <h2>Restaurante Escolar</h2>
    <h3>Diseño: Uv@profe</h3>
  </div>
</header>

<div class="container">
  <div class="row g-3">
    <div class="col-lg-4">

      <!-- Importar y Scanner -->
      <div class="card mb-3">
        <div class="card-body">
          <h5>Importar estudiantes (CSV)</h5>
          <input id="csvFile" type="file" accept=".csv,text/csv" class="form-control mb-2" />
          <button id="importBtn" class="btn w-100 mt-2">Cargar CSV</button>
          <hr/>
          <h5>Escáner QR</h5>
          <div id="scanner-controls" class="mb-2">
            <button id="startScanner" class="btn w-100 mb-1">Iniciar escáner</button>
            <button id="stopScanner" class="btn w-100 mb-1">Detener escáner</button>
          </div>
          <div id="scanner-area" style="display:none;">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <small id="scanStatus" class="text-success"></small>

            <div class="mt-2">
              <label for="gradeFilter" class="form-label">Filtrar por grado:</label>
              <select id="gradeFilter" class="form-select">
                <option value="all">Todos los grados</option>
              </select>
            </div>
            <ul id="todayStudents" class="list-group list-group-flush mt-2"></ul>
            <button id="exportPDF" class="btn w-100 mt-2">Exportar PDF</button>
          </div>
          <hr/>
          <button id="printAll" class="btn w-100">Imprimir todos los QRs</button>
        </div>
      </div>

      <!-- Dashboard -->
      <div class="card mb-3">
        <div class="card-header" onclick="toggleCard(this)">Dashboard (tiempo real)</div>
        <div class="card-body">
          <p>Total estudiantes: <strong id="totalStudents">0</strong></p>
          <p>Asistencias hoy (<span id="todayDate"></span>): <strong id="attToday">0</strong></p>
          <p>Asistencias totales: <strong id="attTotal">0</strong></p>
          <canvas id="attendanceChart" style="width:100%; height:200px;"></canvas>
          <button id="clearData" class="btn btn-sm mt-2">Borrar toda la base (local)</button>
        </div>
      </div>

      <!-- Agregar Estudiante -->
      <div class="card mb-3">
        <div class="card-header" onclick="toggleCard(this)">Agregar Estudiante</div>
        <div class="card-body">
          <button class="btn w-100 mb-2" id="toggleManualForm">Agregar estudiante manualmente</button>
          <div id="manualStudentForm">
            <input type="text" id="manualName" placeholder="Nombre completo" class="form-control mb-1">
            <input type="text" id="manualGrade" placeholder="Grado (ej. 10-3)" class="form-control mb-1">
            <button class="btn w-100" id="addManualStudent">Agregar y generar QR</button>
          </div>
        </div>
      </div>

    </div>
    <div class="col-lg-8">
      <div id="print-area" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
// ==== Funciones base ====
const STORAGE_STUDENTS='rs_students_v1';
const STORAGE_ATT='rs_attendance_v1';
function readStudents(){ return JSON.parse(localStorage.getItem(STORAGE_STUDENTS)||'[]'); }
function writeStudents(a){ localStorage.setItem(STORAGE_STUDENTS,JSON.stringify(a)); }
function readAttendance(){ return JSON.parse(localStorage.getItem(STORAGE_ATT)||'{}'); }
function writeAttendance(o){ localStorage.setItem(STORAGE_ATT,JSON.stringify(o)); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function todayKey(){ return new Date().toISOString().slice(0,10); }

const totalStudentsEl=document.getElementById('totalStudents');
const attTodayEl=document.getElementById('attToday');
const attTotalEl=document.getElementById('attTotal');
document.getElementById('todayDate').textContent=todayKey();
const gradeFilter=document.getElementById('gradeFilter');

// ==== Toggle bloques ====
function toggleCard(header){ const body=header.nextElementSibling; body.classList.toggle('collapsed'); }

// ==== Agregar estudiante manual con QR visible 30s ====
document.getElementById('addManualStudent').addEventListener('click',()=>{
  const name=document.getElementById('manualName').value.trim();
  const grade=document.getElementById('manualGrade').value.trim();
  if(!name||!grade){ alert('Ingrese nombre y grado'); return; }
  const arr=readStudents();
  const student={id:uid(), name, grade, createdAt:new Date().toISOString()};
  arr.push(student);
  writeStudents(arr);
  updateGradeFilter(); renderDashboard(); renderTodayList();

  // Mostrar QR temporal
  const container=document.getElementById('print-area'); container.style.display='block';
  const label=document.createElement('div'); label.className='label';
  const holder=document.createElement('div'); label.appendChild(holder);
  const nameEl=document.createElement('div'); nameEl.className='label-name'; nameEl.textContent=`${student.name} - ${student.grade}`;
  label.appendChild(nameEl); container.appendChild(label);
  const payload=JSON.stringify({name:student.name,grade:student.grade});
  new QRCode(holder,{text:payload,width:140,height:140});
  setTimeout(()=>{ container.removeChild(label); if(container.children.length===0) container.style.display='none'; },30000);
  alert('Estudiante agregado correctamente con su QR.');
});

// ==== Resto de tu código (CSV, Scanner, Dashboard, Print, PDF) ====
</script>
</body>
</html>
